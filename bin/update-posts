#!/usr/bin/env node
const axios = require('axios')
const fs = require('fs')
const _ = require('lodash')
const postCategories = require('../post_categories.json')

async function main() {
  const { data: posts } = await axios.get('https://dev.to/api/articles', { params: { username: 'goamaral' } })

  for (let post of posts) {
    const postFileName = getPostFileName(post)
    const postFilePath = `_posts/${postFileName}.md`
    const { data: postContent } = await axios.get(`https://dev.to/api/articles/${post.id}`)
    const categories = postCategories[postFileName]
    
    fs.writeFileSync(postFilePath, `${buildFrontMatter(post, categories)}\n${postContent.body_markdown}`)
  }
}

function getPostFileName(post) {
  return `${post.created_at.substring(0, 10)}-${_.kebabCase(post.title)}`
}

function buildFrontMatter(post, categories) {
  const items = ['layout: post', `title: ${post.title}`]
  if (categories) items.push(`categories: ${categories}`)
  return `---\n${items.join("\n")}\n---`
}

main()